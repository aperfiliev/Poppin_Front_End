if(!Celigo)var Celigo={};
Celigo.BatchProcess=function(){var c=this,a={actionQueue:[],isInitialRetrievalDone:false,objectsCache:[],total:null,target:null,currentAction:null},e=function(){if(a.objectsCache.length>0){try{var b=a.total-a.objectsCache.length;nlapiGetContext().setPercentComplete(Math.round(b/a.total*1E4)/100)}catch(g){}b=0;for(var f=a.objectsCache.pop();!c.checkIfCanProcessNow(f);){a.objectsCache.unshift(f);f=a.objectsCache.pop();b++;if(b>a.objectsCache.length)throw new Error("endless loop happened in getNextObject");}return f}return null},
h=function(){if(!a.target){a.objectsCache=c.getAllObjects();a.total=a.objectsCache.length;a.target=e()}for(;a.target;){d(a.target);a.target=e()}},d=function(b){if(!a.currentAction){a.actionQueue=c.getListOfRunnableClassnames();a.currentAction=a.actionQueue.shift()}for(;a.currentAction;){eval("new "+a.currentAction+"()").runWrapper(b,c.publicState,a.actionQueue);a.currentAction=a.actionQueue.length>0?a.actionQueue.shift():null}},i=function(){for(var b=0;b<a.objectsCache.length;b++)a.objectsCache[b]=
c.serializeObject(a.objectsCache[b]);a.target=c.serializeObject(a.target);a.publicState=c.publicState;stateStr=JSON.stringify(a);nlapiLogExecution("audit","stateStr",stateStr);b={};b[c.getScriptParameterId()]=stateStr;for(var g="";g!="QUEUED";)g=nlapiScheduleScript(nlapiGetContext().getScriptId(),nlapiGetContext().getDeploymentId(),b);nlapiLogExecution("audit","rescheduled")},j=function(){var b=nlapiGetContext().getSetting("SCRIPT",c.getScriptParameterId());nlapiLogExecution("audit","stateStr",b);
if(b){a=JSON.parse(b);for(b=0;b<a.objectsCache.length;b++)a.objectsCache[b]=c.deserializeObject(a.objectsCache[b]);a.target=c.deserializeObject(a.target);c.publicState=a.publicState}c.publicState.batchProcessStartTime=(new Date).getTime()};this.publicState={};this.start=function(){j();try{h()}catch(b){if(b.getCode&&b.getCode()==="NS_OUT_OF_POINTS")i();else throw b;}};this.getListOfRunnableClassnames=function(){throw new Error("getListOfRunnableClassnames not implemented");};this.getAllObjects=function(){throw new Error("getAllObjects not implemented");
};this.getScriptParameterId=function(){throw new Error("getScriptParameterId not implemented");};this.serializeObject=function(b){return JSON.stringify(b)};this.deserializeObject=function(b){return JSON.parse(b)};this.checkIfCanProcessNow=function(){return true}};Celigo||(Celigo={});
Celigo.Runnable=function(){var c=this;this.getPoints=function(){throw new Error("getPoints not implemented");};this.getSeconds=function(){throw new Error("getSeconds not implemented");};this.run=function(){throw new Error("run not implemented");};this.runWrapper=function(a,e,h){var d=nlapiGetContext().getRemainingUsage();nlapiLogExecution("debug","remaining points "+d);if(d<c.getPoints()+500)throw nlapiCreateError("NS_OUT_OF_POINTS","a");d=600-Math.floor(((new Date).getTime()-e.batchProcessStartTime)/
1E3);nlapiLogExecution("debug","remaining seconds "+d);if(d<c.getSeconds())throw nlapiCreateError("NS_OUT_OF_POINTS","a");c.run(a,e,h)}};